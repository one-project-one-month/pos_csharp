@page "/report/yearly"
@using DotNet8.Pos.App.Models.Report

<MudGrid>
    <MudItem xs="5" sm="3">
        <MudSelect T="int" Label="Select Year" @bind-Value="@selectedYear" Variant="MudBlazor.Variant.Outlined">
            @foreach (var year in AvailableYears)
            {
                <MudSelectItem Value="@year">@year</MudSelectItem>
            }
        </MudSelect>
    </MudItem>
</MudGrid>
<MudButton Class="mt-5 mb-5" Variant="MudBlazor.Variant.Filled" Color="Color.Primary" OnClick="ApplyFilter">Apply</MudButton>
<br />

@if (responseModel is not null)
{
    // Calculate yearly total
    var yearlyTotal = responseModel.Data?.Report?.Sum(x => x.TotalAmount) ?? 0;
    var transactionCount = responseModel.Data?.Report?.Count ?? 0;

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">Yearly Sales Summary - @selectedYear</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Total Sales</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@string.Format("{0:N0} MMK", yearlyTotal)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Transaction Count</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info">@string.Format("{0:N0}", transactionCount)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Average per Transaction</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Warning">@string.Format("{0:N0} MMK", transactionCount > 0 ? yearlyTotal / transactionCount : 0)</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <br />

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Transaction Details</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudSimpleTable Style="overflow-x: auto;">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Invoice Date</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @if (responseModel.Data?.Report != null)
                    {
                        int count = 0;
                        @foreach (var item in responseModel.Data.Report)
                        {
                        <tr>
                            <td>@(++count)</td>
                            <td>@(item.SaleInvoiceDate.ToDateTime().ToString("dd/MMM/yyyy"))</td>
                            <td>@string.Format("{0:N0} MMK", item.TotalAmount)</td>
                        </tr>
                        }
                    }
                </tbody>
            </MudSimpleTable>
            <MudPagination SelectedChanged="PageChanged" Variant="MudBlazor.Variant.Filled" Count="@(responseModel?.PageSetting?.PageCount ?? 0)" Style="margin-top:3%" />
        </MudCardContent>
    </MudCard>
}

@code {
    private ReportListResponseModel? responseModel;
    private int selectedYear { get; set; } = DateTime.Now.Year;
    private int _pageNo = 1;
    private int _pageSize = 10;

    private List<int> AvailableYears => Enumerable.Range(DateTime.Now.Year - 10, 12).ToList();

    private async Task ApplyFilter()
    {
        await InjectService.EnableLoading();

        responseModel = await HttpClientService.ExecuteAsync<ReportListResponseModel>(
            $"{Endpoints.Report}/yearly-report/{selectedYear}/{_pageNo}/{_pageSize}",
            EnumHttpMethod.Get
        );

        await InjectService.DisableLoading();
        StateHasChanged();
    }

    private async Task PageChanged(int i)
    {
        _pageNo = i;
        await ApplyFilter();
    }
}
