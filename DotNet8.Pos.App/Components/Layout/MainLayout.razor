@using DotNet8.Pos.App.Components.Dialogs
@inherits LayoutComponentBase
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<MudLayout>
	@if (_isLoading)
	{
		<div style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:white; z-index:9999; display:flex; justify-content:center; align-items:center;">
			<div class="loader"></div>
		</div>
	}
	else
	{
		<MudAppBar Elevation="1">
			<MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
			<MudText Typo="Typo.h5" Class="ml-3">POS System</MudText>
			<MudSpacer />
			@* <div class="d-none d-md-flex">
			<MudTextField @bind-Value="menuSearchText"
						  Placeholder="Search menu..."
						  Variant="MudBlazor.Variant.Outlined"
						  Margin="Margin.Dense"
						  Adornment="Adornment.Start"
						  AdornmentIcon="@Icons.Material.Filled.Search"
						  Class="mud-width-300"
						  Immediate="true"
						  AdornmentColor="Color.Default"
						  Style="max-width: 300px;" /> 
		</div> *@
			<div class="d-flex d-md-none">
				<MudIconButton Icon="@Icons.Material.Filled.Search" Color="Color.Inherit" OnClick="OpenMobileSearch" />
			</div>
			<MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End" />
		</MudAppBar>

		<MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
			<MudDrawerHeader Class="pa-3">
				<MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="font-weight-bold">Navigation Menu</MudText>
			</MudDrawerHeader>
			<MudNavMenu Dense="true" Class="pa-2" Style="height: calc(100vh - 140px); overflow-y: auto;">
				@if (IsMenuItemVisible("Dashboard"))
				{
					<MudNavLink Match="NavLinkMatch.All" Href="/" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
				}

				@if (IsMenuGroupVisible("Master Data", new List<string> { "Products", "Product Category", "Customers", "Staffs", "Townships", "States" }))
				{
					<MudNavGroup Title="Master Data" Expanded="_masterDataExpanded" Icon="@Icons.Material.Filled.Storage" ExpandedChanged="ToggleMasterData">
						@if (IsMenuItemVisible("Products"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/product" Icon="@Icons.Material.Filled.ProductionQuantityLimits">Products</MudNavLink>
						}
						@if (IsMenuItemVisible("Product Category"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/product-category" Icon="@Icons.Material.Filled.Category">Product Category</MudNavLink>
						}
						@if (IsMenuItemVisible("Customers"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/customer" Icon="@Icons.Material.Filled.Person">Customers</MudNavLink>
						}
						@if (IsMenuItemVisible("Staffs"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/staff" Icon="@Icons.Material.Filled.Person4">Staffs</MudNavLink>
						}
						@if (IsMenuItemVisible("Townships"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/township" Icon="@Icons.Material.Filled.Room">Townships</MudNavLink>
						}
						@if (IsMenuItemVisible("States"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/state" Icon="@Icons.Material.Filled.AddLocation">States</MudNavLink>
						}
					</MudNavGroup>
				}

				@if (IsMenuGroupVisible("Operations", new List<string> { "Sale Invoice", "Tax" }))
				{
					<MudNavGroup Title="Operations" Expanded="_operationsExpanded" Icon="@Icons.Material.Filled.ShoppingCart" ExpandedChanged="ToggleOperations">
						@if (IsMenuItemVisible("Sale Invoice"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/sale-invoice-list" Icon="@Icons.Material.Filled.AssuredWorkload">Sale Invoice</MudNavLink>
						}
						@if (IsMenuItemVisible("Tax"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/tax" Icon="@Icons.Material.Filled.AttachMoney">Tax</MudNavLink>
						}
					</MudNavGroup>
				}

				@if (IsMenuGroupVisible("Reports", new List<string> { "Daily Sales", "Monthly Sales", "Yearly Sales", "Best Selling Products", "Sales by Category", "Shop" }))
				{
					<MudNavGroup Title="Reports" Expanded="_reportsExpanded" Icon="@Icons.Material.Filled.Analytics" ExpandedChanged="ToggleReports">
						@if (IsMenuItemVisible("Daily Sales"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/report/daily" Icon="@Icons.Material.Filled.Today">Daily Sales</MudNavLink>
						}
						@if (IsMenuItemVisible("Monthly Sales"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/report/monthly" Icon="@Icons.Material.Filled.CalendarMonth">Monthly Sales</MudNavLink>
						}
						@if (IsMenuItemVisible("Yearly Sales"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/report/yearly" Icon="@Icons.Material.Filled.DateRange">Yearly Sales</MudNavLink>
						}
						@if (IsMenuItemVisible("Best Selling Products"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/report/best-selling" Icon="@Icons.Material.Filled.Star">Best Selling Products</MudNavLink>
						}
						@if (IsMenuItemVisible("Sales by Category"))
						{
							<MudNavLink Match="NavLinkMatch.All" Href="/report/sales-by-category" Icon="@Icons.Material.Filled.Category">Sales by Category</MudNavLink>
						}
						@if (IsMenuItemVisible("Shop"))
						{
							<MudNavLink Match="NavLinkMatch.Prefix" Href="/shop" Icon="@Icons.Material.Filled.Shop">Shop</MudNavLink>
						}
					</MudNavGroup>
				}

				@if (IsMenuItemVisible("Logout"))
				{
					@if (IsMenuGroupVisible("Reports", new List<string> { "Report", "Shop" }) || IsMenuGroupVisible("Operations", new List<string> { "Sale Invoice", "Tax" }) || IsMenuGroupVisible("Master Data", new List<string> { "Products", "Product Category", "Customers", "Staffs", "Townships", "States" }) || IsMenuItemVisible("Dashboard"))
					{
						<MudDivider Class="my-2" />
					}
					<MudNavLink Match="NavLinkMatch.All"
								OnClick="Logout"
								Style="cursor: pointer;"
								Icon="@Icons.Material.Filled.Logout">
						Logout
					</MudNavLink>
				}
			</MudNavMenu>
		</MudDrawer>

		<MudMainContent>
			<MudContainer Class="pa-4">
				@Body
			</MudContainer>
		</MudMainContent>
	}
</MudLayout>

@code
{
	private bool _drawerOpen = true;
	private bool _isLoading = true;
	private bool _masterDataExpanded = false;
	private bool _operationsExpanded = false;
	private bool _reportsExpanded = false;
	private string menuSearchText = string.Empty;


	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			var state = await AuthStateProvider.GetAuthenticationStateAsync();
			if (!state.User.Identity?.IsAuthenticated ?? true)
			{
				await AuthStateProvider.ClearTokenAsync();
				NavigationManager.NavigateTo("/login");
			}
			else
			{
				UpdateMenuExpansionState();
				NavigationManager.LocationChanged += HandleLocationChanged;

				_isLoading = false;
				await InjectService.DisableLoading();
				StateHasChanged();
			}
		}
	}

	private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
	{
		UpdateMenuExpansionState();
		StateHasChanged();
	}

	private void UpdateMenuExpansionState()
	{
		var currentUri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
		_reportsExpanded = currentUri.AbsolutePath.Contains("/report");
	}


	private void ToggleMasterData(bool value)
	{
		_masterDataExpanded = value;
		if (_masterDataExpanded)
		{
			_operationsExpanded = false;
			_reportsExpanded = false;
		}
	}

	private void ToggleOperations(bool value)
	{
		_operationsExpanded = value;
		if (_operationsExpanded)
		{
			_masterDataExpanded = false;
			_reportsExpanded = false;
		}
	}

	private void ToggleReports(bool value)
	{
		_reportsExpanded = value;
		if (_reportsExpanded)
		{
			_masterDataExpanded = false;
			_operationsExpanded = false;
		}
	}

	private async Task Logout()
	{
		var dialog = await DialogService.ShowAsync<LogoutDialog>("Logout");
		var result = await dialog.Result;

		if (!result.Canceled)
		{
			await AuthStateProvider.ClearTokenAsync();
			NavigationManager.NavigateTo("/login");
		}
	}

	private bool IsMenuItemVisible(string menuText)
	{
		if (string.IsNullOrWhiteSpace(menuSearchText))
			return true;

		return menuText.Contains(menuSearchText, StringComparison.OrdinalIgnoreCase);
	}

	private bool IsMenuGroupVisible(string groupTitle, List<string> menuItems)
	{
		if (string.IsNullOrWhiteSpace(menuSearchText))
			return true;

		// Show group if title matches or any menu item matches
		if (groupTitle.Contains(menuSearchText, StringComparison.OrdinalIgnoreCase))
			return true;

		return menuItems.Any(item => item.Contains(menuSearchText, StringComparison.OrdinalIgnoreCase));
	}

	private async Task OpenMobileSearch()
	{
		var parameters = new DialogParameters
		{
			["SearchText"] = menuSearchText
		};

		var dialog = await DialogService.ShowAsync<MobileMenuSearchDialog>("Search Menu", parameters);
		var result = await dialog.Result;

		if (!result.Canceled && result.Data is string searchText)
		{
			menuSearchText = searchText;
			StateHasChanged();
		}
	}

	private void DrawerToggle()
	{
		_drawerOpen = !_drawerOpen;
	}
}


<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<RadzenComponents />
